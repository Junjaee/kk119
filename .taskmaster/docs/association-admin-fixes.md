# 교권119 협회관리자 오류 수정 PRD (Product Requirements Document)

## 1. 문제 개요

현재 교권119 시스템에서 협회관리자(`admin` 역할) 계정이 로그인 후 시스템의 다양한 기능에 접근할 때 여러 오류가 발생하고 있습니다. 이로 인해 협회관리자가 본연의 업무(회원 승인, 신고 관리 등)를 수행할 수 없는 상황입니다.

## 2. 현재 발생 중인 오류들

### 2.1 Critical Errors (시스템 동작 중단)

#### 2.1.1 API 인증 미들웨어 오류 [CRITICAL]
- **위치**: `lib/auth/api-middleware.ts:40`
- **현상**: 로그인 성공 후 API 호출 시 403 Forbidden 오류 발생
- **원인**: `getUserFromToken()` 비동기 함수를 동기적으로 호출
- **영향**: 모든 admin API 요청 실패
- **로그**: `GET /api/admin/memberships 403` 반복 발생

#### 2.1.2 인증 상태 불일치 오류 [CRITICAL]
- **현상**: "Server-client auth mismatch detected, clearing orphaned cookie" 메시지 반복
- **원인**: 서버와 클라이언트 간 인증 토큰 동기화 실패
- **영향**: 자동 로그아웃 및 세션 무효화
- **패턴**: API 호출 → 403 → 쿠키 클리어 → 재로그인 필요

#### 2.1.3 회원 승인 시스템 접근 불가 [HIGH]
- **위치**: `/admin/memberships` 페이지
- **현상**: 페이지 로드 성공하지만 데이터 fetch 실패 (403)
- **영향**: 협회관리자의 핵심 업무인 교사 가입 승인 불가

### 2.2 UI/UX Errors (사용자 경험 저하)

#### 2.2.1 Missing Assets 오류 [MEDIUM]
- **현상**: `GET /icons/icon-144x144.png 404` 반복 발생
- **영향**: PWA 기능 및 브랜딩 저하
- **빈도**: 모든 페이지 접근 시 발생

#### 2.2.2 Next.js Metadata 경고 [LOW]
- **현상**: Unsupported metadata viewport/themeColor 경고
- **영향**: 개발 로그 오염, SEO 잠재적 영향
- **빈도**: 모든 페이지 컴파일 시 발생

### 2.3 Database Consistency Issues

#### 2.3.1 협회관리자 데이터 불일치 [HIGH]
- **현상**: `association@kk119.com` 사용자가 admins 테이블에 누락
- **영향**: 권한 검증 실패로 인한 접근 거부
- **상태**: 부분적으로 수정됨 (재발 가능성 있음)

## 3. 근본 원인 분석

### 3.1 아키텍처 문제
1. **비동기 처리 불일치**: API 미들웨어에서 async/await 패턴 미준수
2. **인증 토큰 관리**: 서버-클라이언트 간 토큰 상태 동기화 부족
3. **에러 처리**: API 오류 시 적절한 fallback 및 retry 로직 부재

### 3.2 데이터 일관성 문제
1. **역할 기반 데이터**: users 테이블과 admins 테이블 간 일관성 유지 필요
2. **권한 검증**: 역할 변경 시 관련 테이블 동기화 로직 필요

## 4. 수정 요구사항

### 4.1 즉시 수정 필요 (P0 - Critical)

#### 4.1.1 API 미들웨어 비동기 처리 수정
```typescript
// Before (lib/auth/api-middleware.ts:40)
const user = getUserFromToken(token);

// After
const user = await getUserFromToken(token);
```
- **함수 서명 변경**: `authenticateRequest()` → `async authenticateRequest()`
- **호출부 수정**: 모든 미들웨어 호출부에 await 추가
- **테스트**: 로그인 → API 호출 → 성공 확인

#### 4.1.2 인증 상태 동기화 개선
- **토큰 갱신 로직**: 만료 전 자동 갱신
- **에러 핸들링**: 403 오류 시 재인증 시도
- **쿠키 관리**: 서버-클라이언트 토큰 상태 일치 보장

#### 4.1.3 관리자 권한 데이터 일관성 보장
- **데이터 검증**: 로그인 시 admin 역할 → admins 테이블 존재 확인
- **자동 복구**: 누락된 admin 레코드 자동 생성
- **마이그레이션**: 기존 admin 사용자들의 데이터 일관성 검증

### 4.2 단기 수정 (P1 - High)

#### 4.2.1 회원 승인 시스템 안정화
- **API 재시도 로직**: 일시적 오류 시 자동 재시도
- **로딩 상태**: 사용자에게 진행 상황 표시
- **오류 메시지**: 명확한 오류 안내 및 해결 방법 제시

#### 4.2.2 에러 모니터링 개선
- **로그 수준 조정**: 불필요한 경고 로그 제거
- **에러 추적**: 중요 오류에 대한 알림 시스템
- **성능 모니터링**: API 응답 시간 및 성공률 추적

### 4.3 중기 개선 (P2 - Medium)

#### 4.3.1 Missing Assets 수정
- **아이콘 파일 추가**: PWA 필수 아이콘들 생성 및 배포
- **Manifest 수정**: 올바른 아이콘 경로 설정
- **빌드 검증**: 빌드 시 필수 에셋 존재 확인

#### 4.3.2 Next.js 설정 최적화
- **Metadata 구조**: viewport/themeColor를 올바른 위치로 이동
- **Turbopack 설정**: webpack 경고 제거
- **컴파일 최적화**: 불필요한 재컴파일 방지

## 5. 수정 계획

### Phase 1: 핵심 인증 시스템 수정 (1-2일)
1. API 미들웨어 비동기 처리 수정
2. 인증 상태 동기화 로직 개선
3. 기본 API 호출 테스트

### Phase 2: 데이터 일관성 및 안정성 (2-3일)
1. 관리자 권한 데이터 검증 및 복구
2. 회원 승인 시스템 안정화
3. 에러 핸들링 개선

### Phase 3: UI/UX 개선 (1-2일)
1. Missing assets 수정
2. Next.js 설정 최적화
3. 전체 시스템 테스트

## 6. 성공 기준

### 6.1 기능 검증
- [ ] 협회관리자 로그인 → 대시보드 접근 성공
- [ ] `/admin/memberships` 페이지에서 데이터 로드 성공
- [ ] 회원 승인/거부 기능 정상 동작
- [ ] 세션 유지 기간 동안 자동 로그아웃 없음

### 6.2 기술 검증
- [ ] API 호출 시 403 오류 0건
- [ ] "Server-client auth mismatch" 메시지 0건
- [ ] 페이지 로드 시 404 에러 0건
- [ ] Next.js 컴파일 경고 0건

### 6.3 사용자 경험
- [ ] 협회관리자가 중단 없이 업무 수행 가능
- [ ] 명확한 에러 메시지 및 가이드 제공
- [ ] 반응형 UI 및 적절한 로딩 상태 표시

## 7. 위험 요소 및 대응

### 7.1 기술적 위험
- **인증 시스템 변경**: 기존 세션 무효화 가능성
  - **대응**: 단계적 배포 및 세션 마이그레이션
- **데이터베이스 변경**: 기존 데이터 손실 위험
  - **대응**: 백업 및 롤백 계획 수립

### 7.2 운영 위험
- **사용자 혼란**: 수정 과정에서 일시적 접근 불가
  - **대응**: 사전 공지 및 빠른 수정 완료
- **데이터 일관성**: 수정 중 신규 가입자 처리
  - **대응**: 트랜잭션 기반 안전한 데이터 처리

## 8. 테스트 계획

### 8.1 단위 테스트
- API 미들웨어 인증 함수
- 토큰 검증 및 사용자 정보 추출
- 권한 검증 로직

### 8.2 통합 테스트
- 로그인 → 대시보드 → 회원 관리 플로우
- 다양한 역할(super_admin, admin) 간 권한 차이
- 브라우저별 쿠키 및 세션 관리

### 8.3 E2E 테스트
- Playwright를 통한 실제 사용자 시나리오
- 협회관리자 전체 워크플로우 검증
- 오류 상황 시나리오 테스트

## 9. 완료 후 추가 개선사항

### 9.1 모니터링 강화
- 인증 실패율 대시보드
- API 응답 시간 모니터링
- 사용자 행동 패턴 분석

### 9.2 보안 강화
- JWT 토큰 만료 시간 최적화
- 브루트포스 공격 방지
- 세션 관리 보안 강화

### 9.3 사용자 경험 개선
- 오프라인 모드 지원
- 다국어 지원 확장
- 접근성(a11y) 개선

---

**문서 작성일**: 2025-09-27
**우선순위**: P0 (Critical)
**예상 소요시간**: 5-7일
**담당자**: 개발팀
**검토자**: 시스템 관리자

이 PRD를 기반으로 협회관리자 오류들을 체계적으로 수정하여 안정적인 시스템을 구축할 수 있습니다.